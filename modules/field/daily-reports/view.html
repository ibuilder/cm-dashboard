modules\field\daily-reports\view.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Daily Report - CMDashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../../assets/css/custom.css">
    <link rel="stylesheet" href="../../../assets/css/components/sidebar.css">
    <script src="../../../config/supabase-config.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
    </script>
    <script src="../../../assets/js/core/auth.js" defer></script>
    <script src="../../../assets/js/core/permissions.js" defer></script>
    <script src="../../../assets/js/core/supabase-client.js" defer></script>
    <script src="../../../assets/js/utils/export-pdf.js" defer></script>
    <script src="daily-reports.js" defer></script>
</head>
<body>
    <div class="wrapper">
        <!-- Include sidebar -->
        <div id="sidebar-container"></div>
        
        <div class="main-content">
            <!-- Include header -->
            <div id="header-container"></div>
            
            <div class="container-fluid py-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h1 class="h3">View Daily Report</h1>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="../../../pages/dashboard.html">Dashboard</a></li>
                                <li class="breadcrumb-item">Field</li>
                                <li class="breadcrumb-item"><a href="list.html">Daily Reports</a></li>
                                <li class="breadcrumb-item active" aria-current="page">View Daily Report</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="export-pdf" class="btn btn-outline-secondary me-2">
                            <i class="bi bi-file-pdf me-1"></i> Export PDF
                        </button>
                        <a id="edit-button" href="#" class="btn btn-primary permission-update me-2">
                            <i class="bi bi-pencil me-1"></i> Edit
                        </a>
                        <button id="delete-button" class="btn btn-danger permission-delete">
                            <i class="bi bi-trash me-1"></i> Delete
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Daily Report Details</h5>
                                <span id="status-badge" class="badge bg-primary">Submitted</span>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-3 text-muted">Report Number</div>
                                    <div class="col-md-9 fw-medium" id="report-number"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3 text-muted">Report Date</div>
                                    <div class="col-md-9" id="report-date"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3 text-muted">Author</div>
                                    <div class="col-md-9" id="author"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3 text-muted">Weather</div>
                                    <div class="col-md-9" id="weather"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3 text-muted">Temperature</div>
                                    <div class="col-md-9" id="temperature"></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3 text-muted">Precipitation</div>
                                    <div class="col-md-9" id="precipitation"></div>
                                </div>
                                <hr>
                                <h6 class="mb-3">Work Performed</h6>
                                <div id="work-performed" class="border rounded p-3 bg-light mb-4"></div>
                                
                                <h6 class="mb-3">Manpower</h6>
                                <div class="table-responsive mb-4">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Company</th>
                                                <th>Trade</th>
                                                <th>Workers</th>
                                                <th>Hours</th>
                                            </tr>
                                        </thead>
                                        <tbody id="manpower-table">
                                            <tr>
                                                <td colspan="4" class="text-center">No manpower records</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <h6 class="mb-3">Equipment</h6>
                                <div class="table-responsive mb-4">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Type</th>
                                                <th>Description</th>
                                                <th>Quantity</th>
                                                <th>Hours</th>
                                            </tr>
                                        </thead>
                                        <tbody id="equipment-table">
                                            <tr>
                                                <td colspan="4" class="text-center">No equipment records</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <h6 class="mb-3">Materials Delivered</h6>
                                <div class="table-responsive mb-4">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Supplier</th>
                                                <th>Description</th>
                                                <th>Quantity</th>
                                                <th>Unit</th>
                                            </tr>
                                        </thead>
                                        <tbody id="materials-table">
                                            <tr>
                                                <td colspan="4" class="text-center">No materials delivered</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <h6 class="mb-3">Issues / Delays</h6>
                                <div id="issues" class="border rounded p-3 bg-light"></div>
                            </div>
                        </div>
                        
                        <!-- Attachments -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Attachments</h5>
                            </div>
                            <div class="card-body">
                                <div id="attachments-container">
                                    <div class="text-center py-4 text-muted">
                                        <i class="bi bi-file-earmark-text fs-2"></i>
                                        <p>No attachments found</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <!-- Activity Log -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Activity Log</h5>
                            </div>
                            <div class="card-body p-0">
                                <div id="activity-log" class="list-group list-group-flush">
                                    <div class="list-group-item text-center">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Loading activity...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comments -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Comments</h5>
                            </div>
                            <div class="card-body">
                                <div id="comments-container">
                                    <!-- Comments will be loaded here -->
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Loading comments...</span>
                                    </div>
                                </div>
                                <form id="comment-form" class="mt-3">
                                    <div class="form-group">
                                        <textarea id="comment-text" class="form-control" rows="3" placeholder="Write a comment..."></textarea>
                                    </div>
                                    <div class="mt-2 text-end">
                                        <button type="submit" class="btn btn-primary" id="post-comment">
                                            <i class="bi bi-chat-text me-1"></i> Post Comment
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Include footer -->
            <div id="footer-container"></div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="delete-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this daily report? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let reportId;
        let reportData;
        let deleteModal;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error || !user) {
                    window.location.href = '../../../pages/auth/login.html';
                    return;
                }
                
                // Get report ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                reportId = urlParams.get('id');
                
                if (!reportId) {
                    alert('No report ID provided');
                    window.location.href = 'list.html';
                    return;
                }
                
                // Initialize delete modal
                deleteModal = new bootstrap.Modal(document.getElementById('delete-modal'));
                
                // Load components
                await loadComponents();
                
                // Load report data
                await loadReportData();
                
                // Load comments
                await loadComments();
                
                // Load activity log
                await loadActivityLog();
                
                // Set up event listeners
                setupEventListeners();
                
                // Apply permissions
                permissionsManager.applyPermissions();
            } catch (error) {
                console.error('Error initializing page:', error);
                alert('An error occurred while loading the page. Please try refreshing.');
            }
        });
        
        async function loadComponents() {
            try {
                const headerContainer = document.getElementById('header-container');
                const sidebarContainer = document.getElementById('sidebar-container');
                const footerContainer = document.getElementById('footer-container');
                
                const headerResponse = await fetch('../../../components/layout/header.html');
                const sidebarResponse = await fetch('../../../components/layout/sidebar.html');
                const footerResponse = await fetch('../../../components/layout/footer.html');
                
                headerContainer.innerHTML = await headerResponse.text();
                sidebarContainer.innerHTML = await sidebarResponse.text();
                footerContainer.innerHTML = await footerResponse.text();
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }
        
        async function loadReportData() {
            try {
                const { data, error } = await supabase
                    .from('daily_reports')
                    .select(`
                        *,
                        author:author_id(id, first_name, last_name, email),
                        creator:created_by(id, first_name, last_name, email),
                        manpower:daily_report_manpower(id, company, trade, workers, hours),
                        equipment:daily_report_equipment(id, type, description, quantity, hours),
                        materials:daily_report_materials(id, supplier, description, quantity, unit)
                    `)
                    .eq('id', reportId)
                    .single();
                
                if (error) throw error;
                
                reportData = data;
                
                // Display report data
                document.getElementById('report-number').textContent = reportData.report_number || '';
                document.getElementById('report-date').textContent = dailyReportsModule.formatDate(reportData.report_date) || '';
                document.getElementById('author').textContent = reportData.author ? 
                    `${reportData.author.first_name} ${reportData.author.last_name}` : '';
                
                // Weather info
                const weatherHtml = dailyReportsModule.getWeatherHtml(reportData.weather_condition);
                document.getElementById('weather').innerHTML = weatherHtml;
                
                document.getElementById('temperature').textContent = reportData.temperature ? 
                    `${reportData.temperature}° ${reportData.temperature_unit || 'F'}` : '—';
                document.getElementById('precipitation').textContent = reportData.precipitation ? 
                    `${reportData.precipitation} ${reportData.precipitation_unit || 'in'}` : '—';
                
                // Work performed and issues
                document.getElementById('work-performed').innerHTML = reportData.work_performed || '—';
                document.getElementById('issues').innerHTML = reportData.issues || '—';
                
                // Update status badge
                const statusBadge = document.getElementById('status-badge');
                statusBadge.className = 'badge ' + dailyReportsModule.getStatusBadgeClass(reportData.status);
                statusBadge.innerHTML = `<i class="bi ${dailyReportsModule.getStatusIcon(reportData.status)} me-1"></i>${dailyReportsModule.formatStatus(reportData.status)}`;
                
                // Set edit button URL
                document.getElementById('edit-button').href = `form.html?id=${reportId}`;
                
                // Check if user can delete this report
                const userData = authService.getUserData();
                if (userData && reportData.created_by === userData.id) {
                    document.getElementById('delete-button').classList.add('permission-delete-own');
                    document.getElementById('delete-button').dataset.creatorId = reportData.created_by;
                }
                
                // Update manpower table
                updateManpowerTable(reportData.manpower || []);
                
                // Update equipment table
                updateEquipmentTable(reportData.equipment || []);
                
                // Update materials table
                updateMaterialsTable(reportData.materials || []);
                
                // Load attachments
                await loadAttachments();
            } catch (error) {
                console.error('Error loading report:', error);
                alert('Failed to load report data. Please try again.');
            }
        }
        
        function updateManpowerTable(manpower) {
            const manpowerTable = document.getElementById('manpower-table');
            
            if (!manpower || manpower.length === 0) {
                manpowerTable.innerHTML = '<tr><td colspan="4" class="text-center">No manpower records</td></tr>';
                return;
            }
            
            let html = '';
            
            manpower.forEach(item => {
                html += `
                    <tr>
                        <td>${item.company || '—'}</td>
                        <td>${item.trade || '—'}</td>
                        <td>${item.workers || '0'}</td>
                        <td>${item.hours || '0'}</td>
                    </tr>
                `;
            });
            
            manpowerTable.innerHTML = html;
        }
        
        function updateEquipmentTable(equipment) {
            const equipmentTable = document.getElementById('equipment-table');
            
            if (!equipment || equipment.length === 0) {
                equipmentTable.innerHTML = '<tr><td colspan="4" class="text-center">No equipment records</td></tr>';
                return;
            }
            
            let html = '';
            
            equipment.forEach(item => {
                html += `
                    <tr>
                        <td>${item.type || '—'}</td>
                        <td>${item.description || '—'}</td>
                        <td>${item.quantity || '0'}</td>
                        <td>${item.hours || '0'}</td>
                    </tr>
                `;
            });
            
            equipmentTable.innerHTML = html;
        }
        
        function updateMaterialsTable(materials) {
            const materialsTable = document.getElementById('materials-table');
            
            if (!materials || materials.length === 0) {
                materialsTable.innerHTML = '<tr><td colspan="4" class="text-center">No materials delivered</td></tr>';
                return;
            }
            
            let html = '';
            
            materials.forEach(item => {
                html += `
                    <tr>
                        <td>${item.supplier || '—'}</td>
                        <td>${item.description || '—'}</td>
                        <td>${item.quantity || '0'}</td>
                        <td>${item.unit || '—'}</td>
                    </tr>
                `;
            });
            
            materialsTable.innerHTML = html;
        }
        
        async function loadAttachments() {
            try {
                // Fetch attachments related to this report
                const { data, error } = await supabase
                    .from('attachments')
                    .select('*')
                    .eq('module_table', 'daily_reports')
                    .eq('record_id', reportId);
                
                if (error) throw error;
                
                const attachmentsContainer = document.getElementById('attachments-container');
                
                if (!data || data.length === 0) {
                    // Already showing "No attachments" message
                    return;
                }
                
                let html = '<div class="list-group">';
                
                for (const attachment of data) {
                    const filename = attachment.file_name || 'Attachment';
                    const fileUrl = attachment.file_url;
                    const fileDate = dailyReportsModule.formatDate(attachment.created_at);
                    
                    html += `
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-file-earmark me-2"></i>
                                <a href="${fileUrl}" target="_blank">${filename}</a>
                                <small class="text-muted ms-2">Added ${fileDate}</small>
                            </div>
                            <a href="${fileUrl}" download class="btn btn-sm btn-light" title="Download">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    `;
                }
                
                html += '</div>';
                attachmentsContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading attachments:', error);
            }
        }
        
        async function loadComments() {
            try {
                const result = await supabaseAPI.getComments('daily_reports', reportId);
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load comments');
                }
                
                const comments = result.data;
                const commentsContainer = document.getElementById('comments-container');
                
                if (!comments || comments.length === 0) {
                    commentsContainer.innerHTML = `
                        <div class="text-center py-3 text-muted">
                            <i class="bi bi-chat fs-4"></i>
                            <p class="mb-0">No comments yet</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                for (const comment of comments) {
                    const date = new Date(comment.created_at);
                    const formattedDate = `${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
                    
                    html += `
                        <div class="comment mb-3">
                            <div class="d-flex">
                                <div class="me-2">
                                    <div class="avatar-circle bg-primary text-white">
                                        ${getInitials(comment.users.first_name, comment.users.last_name)}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="fw-medium">${comment.users.first_name} ${comment.users.last_name}</div>
                                        <small class="text-muted">${formattedDate}</small>
                                    </div>
                                    <div class="comment-text mt-1">${comment.comment_text}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                commentsContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading comments:', error);
                const commentsContainer = document.getElementById('comments-container');
                commentsContainer.innerHTML = '<div class="alert alert-danger">Failed to load comments</div>';
            }
        }
        
        async function loadActivityLog() {
            try {
                // Fetch activity log for this report
                const { data, error } = await supabase
                    .from('activity_log')
                    .select(`
                        *,
                        users:user_id (first_name, last_name)
                    `)
                    .eq('module_name', 'daily_reports')
                    .eq('record_id', reportId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const activityLog = document.getElementById('activity-log');
                
                if (!data || data.length === 0) {
                    activityLog.innerHTML = `
                        <div class="list-group-item text-center text-muted py-3">
                            <i class="bi bi-clock-history fs-4 d-block mb-1"></i>
                            No activity recorded
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                for (const activity of data) {
                    const date = new Date(activity.created_at);
                    const formattedDate = `${date.toLocaleDateString()} at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex">
                                <div class="me-2">
                                    <div class="avatar-circle ${getActivityIconClass(activity.action)} text-white">
                                        <i class="bi ${getActivityIcon(activity.action)}"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="small text-muted">${formattedDate}</div>
                                    <div>${activity.description}</div>
                                    <div class="small text-muted">By ${activity.users ? activity.users.first_name + ' ' + activity.users.last_name : 'System'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                activityLog.innerHTML = html;
            } catch (error) {
                console.error('Error loading activity log:', error);
                const activityLog = document.getElementById('activity-log');
                activityLog.innerHTML = '<div class="list-group-item text-danger">Failed to load activity log</div>';
            }
        }
        
        function setupEventListeners() {
            // Export to PDF
            document.getElementById('export-pdf').addEventListener('click', async function() {
                try {
                    // Create a new jsPDF instance
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add header
                    doc.setFontSize(18);
                    doc.text(`Daily Report #${reportData.report_number}`, 14, 22);
                    
                    // Add status and date
                    doc.setFontSize(12);
                    doc.text(`Status: ${dailyReportsModule.formatStatus(reportData.status)}`, 14, 30);
                    doc.text(`Date: ${dailyReportsModule.formatDate(reportData.report_date)}`, 14, 37);
                    
                    // Add metadata
                    doc.setFontSize(11);
                    doc.text(`Author: ${reportData.author ? reportData.author.first_name + ' ' + reportData.author.last_name : ''}`, 14, 47);
                    
                    // Find weather condition label
                    const weatherCondition = dailyReportsModule.WEATHER_CONDITIONS.find(w => w.value === reportData.weather_condition);
                    const weatherLabel = weatherCondition ? weatherCondition.label : reportData.weather_condition;
                    
                    doc.text(`Weather: ${weatherLabel || ''}`, 14, 54);
                    
                    if (reportData.temperature) {
                        doc.text(`Temperature: ${reportData.temperature}° ${reportData.temperature_unit || 'F'}`, 14, 61);
                    }
                    
                    if (reportData.precipitation) {
                        doc.text(`Precipitation: ${reportData.precipitation} ${reportData.precipitation_unit || 'in'}`, 14, 68);
                    }
                    
                    // Add work performed
                    doc.setFontSize(12);
                    doc.text('Work Performed:', 14, 78);
                    doc.setFontSize(11);
                    
                    const workPerformed = reportData.work_performed.replace(/<[^>]*>/g, '') || '';
                    const splitWorkPerformed = doc.splitTextToSize(workPerformed, 180);
                    doc.text(splitWorkPerformed, 14, 85);
                    
                    let yPosition = 85 + (splitWorkPerformed.length * 7);
                    
                    // Add issues if any
                    if (reportData.issues) {
                        doc.setFontSize(12);
                        doc.text('Issues / Delays:', 14, yPosition + 10);
                        doc.setFontSize(11);
                        
                        const issues = reportData.issues.replace(/<[^>]*>/g, '') || '';
                        const splitIssues = doc.splitTextToSize(issues, 180);
                        doc.text(splitIssues, 14, yPosition + 17);
                        
                        yPosition += 17 + (splitIssues.length * 7);
                    }
                    
                    // Add manpower section if any
                    if (reportData.manpower && reportData.manpower.length > 0) {
                        // Check if we need a new page
                        if (yPosition > 230) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        doc.setFontSize(12);
                        doc.text('Manpower:', 14, yPosition + 10);
                        
                        yPosition += 15;
                        
                        // Add manpower table headers
                        doc.setFontSize(10);
                        doc.text('Company', 14, yPosition);
                        doc.text('Trade', 64, yPosition);
                        doc.text('Workers', 114, yPosition);
                        doc.text('Hours', 154, yPosition);
                        
                        yPosition += 5;
                        doc.line(14, yPosition, 196, yPosition); // Draw line under headers
                        
                        yPosition += 8;
                        
                        // Add manpower table data
                        reportData.manpower.forEach(item => {
                            doc.text(item.company || '—', 14, yPosition);
                            doc.text(item.trade || '—', 64, yPosition);
                            doc.text(item.workers?.toString() || '0', 114, yPosition);
                            doc.text(item.hours?.toString() || '0', 154, yPosition);
                            
                            yPosition += 8;
                            
                            // Check if we need a new page
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 20;
                            }
                        });
                        
                        yPosition += 5;
                    }
                    
                    // Add equipment section if any
                    if (reportData.equipment && reportData.equipment.length > 0) {
                        // Check if we need a new page
                        if (yPosition > 230) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        doc.setFontSize(12);
                        doc.text('Equipment:', 14, yPosition + 10);
                        
                        yPosition += 15;
                        
                        // Add equipment table headers
                        doc.setFontSize(10);
                        doc.text('Type', 14, yPosition);
                        doc.text('Description', 64, yPosition);
                        doc.text('Quantity', 114, yPosition);
                        doc.text('Hours', 154, yPosition);
                        
                        yPosition += 5;
                        doc.line(14, yPosition, 196, yPosition); // Draw line under headers
                        
                        yPosition += 8;
                        
                        // Add equipment table data
                        reportData.equipment.forEach(item => {
                            doc.text(item.type || '—', 14, yPosition);
                            doc.text(item.description || '—', 64, yPosition);
                            doc.text(item.quantity?.toString() || '0', 114, yPosition);
                            doc.text(item.hours?.toString() || '0', 154, yPosition);
                            
                            yPosition += 8;
                            
                            // Check if we need a new page
                            if (yPosition > 270) {
                                doc.addPage();
                                yPosition = 20;
                            }
                        });
                    }
                    
                    // Save PDF
                    doc.save(`daily-report-${reportData.report_number}.pdf`);
                } catch (error) {
                    console.error('Error exporting to PDF:', error);
                    alert('Failed to export to PDF. Please try again.');
                }
            });
            
            // Delete report
            document.getElementById('delete-button').addEventListener('click', function() {
                deleteModal.show();
            });
            
            // Confirm delete
            document.getElementById('confirm-delete').addEventListener('click', async function() {
                try {
                    const result = await dailyReportsModule.deleteDailyReport(reportId);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to delete report');
                    }
                    
                    deleteModal.hide();
                    alert('Daily report deleted successfully');
                    window.location.href = 'list.html';
                } catch (error) {
                    console.error('Error deleting report:', error);
                    alert('Failed to delete report. Please try again.');
                }
            });
            
            // Post comment
            document.getElementById('comment-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const commentText = document.getElementById('comment-text').value.trim();
                
                if (!commentText) {
                    return;
                }
                
                try {
                    const result = await supabaseAPI.addComment('daily_reports', reportId, commentText);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'Failed to post comment');
                    }
                    
                    // Clear comment field
                    document.getElementById('comment-text').value = '';
                    
                    // Reload comments
                    await loadComments();
                    
                    // Also reload activity log as a new entry should be there
                    await loadActivityLog();
                } catch (error) {
                    console.error('Error posting comment:', error);
                    alert('Failed to post comment. Please try again.');
                }
            });
        }
        
        function getInitials(firstName, lastName) {
            return (firstName?.charAt(0) || '') + (lastName?.charAt(0) || '');
        }
        
        function getActivityIcon(action) {
            const icons = {
                'create': 'bi-plus-circle',
                'update': 'bi-pencil',
                'delete': 'bi-trash',
                'comment': 'bi-chat-text',
                'status_change': 'bi-arrow-repeat',
                'attachment': 'bi-paperclip',
                'view': 'bi-eye'
            };
            
            return icons[action] || 'bi-clock-history';
        }
        
        function getActivityIconClass(action) {
            const classes = {
                'create': 'bg-success',
                'update': 'bg-primary',
                'delete': 'bg-danger',
                'comment': 'bg-info',
                'status_change': 'bg-warning',
                'attachment': 'bg-secondary',
                'view': 'bg-light text-dark'
            };
            
            return classes[action] || 'bg-secondary';
        }
    </script>
</body>
</html>